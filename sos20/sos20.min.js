var electron=.00054386734,end3mass=0,end5mass=0,furanmass=0,symbols=[],bases=[],basemass=[],sugars=[],sugarmass=[],link1=[],link1mass=[],link2=[],link2mass=[],link3=[],link3mass=[],elements=[],elmass=[],massElem=[],allData=[],allKeys=[],allInt=[];function myFunction(){calcNew()}function changeMenu(e){"item1"==e?(document.getElementById("myInput").style.display="block",document.getElementById("mySpectrum").style.display="none",document.getElementById("mySequence").style.display="none",document.getElementById("myAbout").style.display="none"):"item2"==e?(document.getElementById("myInput").style.display="none",document.getElementById("mySpectrum").style.display="none",document.getElementById("mySequence").style.display="block",document.getElementById("myAbout").style.display="none",calcNew()):"item3"==e?(document.getElementById("myInput").style.display="none",document.getElementById("mySpectrum").style.display="block",document.getElementById("mySequence").style.display="none",document.getElementById("myAbout").style.display="none",drawSpec()):"item4"==e&&(document.getElementById("myInput").style.display="none",document.getElementById("mySpectrum").style.display="none",document.getElementById("mySequence").style.display="none",document.getElementById("myAbout").style.display="block"),document.getElementById("item1").style.color="white",document.getElementById("item2").style.color="white",document.getElementById("item3").style.color="white",document.getElementById("item4").style.color="white",document.getElementById(e).style.color="yellow"}function changeIontype(){var e=["w","a-B","d-H2O","y","int"],t=document.getElementById("iontype");t.value=e[(e.indexOf(t.value)+1)%e.length],calcNew()}function changeCharge(e){var t=document.getElementById("charge");t.value=0==e?-1:1*t.value+e,calcNew()}function clearSeq(){var e=document.getElementById("seq");e.value="",(e=document.getElementById("charge")).value=-1,(e=document.getElementById("iontype")).value="w",calcNew()}function makeArray(e){return e.split(/=/)[1].split(/\|/)}function initConf(){end3mass=0,end5mass=0,furanmass=0,symbols=[],bases=[],basemass=[],sugars=[],sugarmass=[],link1=[],link1mass=[],link2=[],link2mass=[],link3=[],link3mass=[],elements=[],elmass=[],massElem=[],document.getElementById("seq").value="";var e=document.getElementById("confFileContent").textContent.split(/\r\n|\n/);document.getElementById("confRec").textContent="["+e.length+" lines read]";for(var t=0;t<e.length;t++)if(e[t].includes("elements"))elements=makeArray(e[t]);else if(e[t].includes("elmass")){elmass=makeArray(e[t]);for(var l=0;l<elements.length;l++)massElem[elements[l]]=elmass[l]}else if(e[t].includes("end3")){var n=e[t].split(/=/);end3mass=calcMass(n[1])}else if(e[t].includes("end5")){n=e[t].split(/=/);end5mass=calcMass(n[1])}else if(e[t].includes("furan")){n=e[t].split(/=/);furanmass=calcMass(n[1])}else if(e[t].includes("symbols"))(symbols=makeArray(e[t])).length=symbols.length<8?symbols.length:8;else if(e[t].includes("bases")){bases=makeArray(e[t]);for(l=0;l<symbols.length;l++)basemass[symbols[l]]=calcMass(bases[l])}else if(e[t].includes("sugars")){sugars=makeArray(e[t]);for(l=0;l<symbols.length;l++)sugarmass[symbols[l]]=calcMass(sugars[l])}else if(e[t].includes("link1")){link1=makeArray(e[t]);for(l=0;l<symbols.length;l++)link1mass[symbols[l]]=calcMass(link1[l])}else if(e[t].includes("link2")){link2=makeArray(e[t]);for(l=0;l<symbols.length;l++)link2mass[symbols[l]]=calcMass(link2[l])}else if(e[t].includes("link3")){link3=makeArray(e[t]);for(l=0;l<symbols.length;l++)link3mass[symbols[l]]=calcMass(link3[l])}}function initData(){allData=[],allKeys=[],allInt=[];for(var e=document.getElementById("dataFileContent").textContent,t=document.getElementById("specInfo"),l=e.split(/\r\n|\n/),n=[],s=0;s<l.length;s++)(n=l[s].split(/ |\t/))[0].match(/\d+[\\.\d]/)&&(allData[n[0]]=Number(n[1])),l[s].match(/^\:/)&&(t.textContent=t.textContent+l[s]+"\n");allKeys=Object.keys(allData),allInt=allKeys.map((function(e){return allData[e]})),document.getElementById("dataRec").textContent="["+allKeys.length+" peaks read]"}function addRec(e){var t=e.match(/\d/);document.getElementById("seq").value;document.getElementById("seq").value+=symbols[t],calcNew()}function drawCanvas(e,t){if(t.match(/./)){document.getElementById(e).style.display="inline-block";var l=document.getElementById(e);l.width=l.height*(l.clientWidth/l.clientHeight);var n=l.getContext("2d");return n.clearRect(0,0,l.width,l.height),n.width=300,n.height=600,n.globalAlpha=.05,n.textAlign="center",n.font="127px Arial",n.fillStyle="#000000",n.fillText(t,75,200),n.globalAlpha=1,n.strokeStyle="#000000",n.lineWidth=1,n.beginPath(),n.moveTo(10,275),n.lineTo(140,275),n.moveTo(75,275),n.lineTo(75,285),n.moveTo(45,275),n.lineTo(45,280),n.moveTo(105,275),n.lineTo(105,280),n.moveTo(15,275),n.lineTo(15,280),n.moveTo(135,275),n.lineTo(135,280),n.stroke(),n}return document.getElementById(e).style.display="none",0}function drawPeak(e,t,l,n){var s,a;s=Math.round(75+30*(l-t)),a=Math.round(allData[l]/n*250),e.strokeStyle="#800000",e.lineWidth=1,e.beginPath(),e.moveTo(s,274),e.lineTo(s,274-a),e.stroke(),e.globalAlpha=1,e.font="10px Arial",e.fillStyle="#800000",e.textAlign="right",e.fillText(n,140,20)}function specPos(e,t,l){return 15+720/(t-e)*(l-e)}function drawSpec(){if(0==Object.keys(allData).length)return 0;document.getElementById("specCanvas").style.visibility="visible",document.getElementById("specCanvas").style.display="inline-block";var e=document.getElementById("specCanvas");e.width=e.height*(e.clientWidth/e.clientHeight);var t=e.getContext("2d");t.clearRect(0,0,e.width,e.height),t.strokeStyle="#000000",t.lineWidth=1,t.beginPath(),t.moveTo(10,375),t.lineTo(740,375),t.stroke();var l=Math.max.apply(null,allKeys),n=Math.min.apply(null,allKeys);l=100*Math.ceil(l/100),n=100*Math.floor(n/100);var s=0,a=0;t.globalAlpha=1,t.font="10px Arial",t.fillStyle="#000000",t.strokeStyle="#000000",t.textAlign="center";for(var o=n;o<=l;o+=100)s=specPos(n,l,o),t.beginPath(),t.moveTo(s,380),t.lineTo(s,375),t.stroke(),t.fillText(o,s,392);for(o=n+50;o<=l;o+=100)s=specPos(n,l,o),t.beginPath(),t.moveTo(s,378),t.lineTo(s,375),t.stroke();var m=Math.max.apply(null,allInt);t.strokeStyle="#800000";for(o=0;o<=allKeys.length;o++)s=specPos(n,l,allKeys[o]),a=350*allData[allKeys[o]]/m,a=Math.round(a),t.beginPath(),t.moveTo(s,374),t.lineTo(s,374-a),t.stroke()}function calcNew(){var e=0,t=document.getElementById("seq").value.toUpperCase(),l=document.getElementById("iontype").value,n=[],s=[],a=[];document.getElementById("seq").value=t;for(var o=0;o<symbols.length;o++){var m=[];n[o]=drawCanvas("myCanvas"+o,symbols[o]),s[o]=calcSeq(n[o],t+symbols[o],l);for(var i=0;i<allKeys.length;i++)Number(allKeys[i])<=s[o]+2&&Number(allKeys[i])>=s[o]-2&&(m.push(allKeys[i]),e=allData[allKeys[i]]>e?allData[allKeys[i]]:e);a.push(m)}for(o=0;o<symbols.length;o++)for(i=0;i<a[o].length;i++)drawPeak(n[o],s[o],a[o][i],e)}function calcMass(e){var t=0,l=e.split(/\D/);l.splice(0,1),e=e.replace(/\d/g,""),arr2=e.split("");for(var n=0;n<l.length;n++)""==l[n]?l[n]=1:l[n]=Number(l[n]),t+=l[n]*massElem[arr2[n]];return t}function calcSeq(e,t,l){for(var n,s=Number(massElem.H),a=0;a<t.length;a++)s+=sugarmass[t[a]],s+=basemass[t[a]],s+=link1mass[t[a]],s+=link2mass[t[a]],s+=link3mass[t[a]];"w"==l?s+=end3mass:"a-B"==l?s+=end5mass+sugarmass[symbols[1]]-calcMass("H3"):"y"==l?s+=end3mass-link1mass[t[t.length-1]]-link2mass[t[t.length-1]]:"d-H2O"==l?s+=end5mass-calcMass("H2O"):"int"==l&&(s+=0-calcMass("H2")+link1mass[t[t.length-1]]+link2mass[t[t.length-1]]+link3mass[t[t.length-1]]+sugarmass[t[t.length-1]]);var o=Number(document.getElementById("charge").value);return s+=-1*o*(electron-Number(massElem.H)),n=s/=Math.abs(0==o?1:o),s=(s=Math.round(1e3*s)/1e3+"00").substring(0,s.indexOf(".")+4),l.match(/./)&&(e.globalAlpha=1,e.font="10px Arial",e.fillStyle="#000000",e.textAlign="center",e.fillText(s,75,295)),n}function getConfDNA(){fetch("https://mstoolbox.github.io/sos20/confDNA.txt").then((e=>e.text()))}window.onload=function(){var e=document.getElementById("confFile"),t=document.getElementById("confFileContent");e.addEventListener("change",(function(l){var n=e.files[0];if(n.type.match(/text.*/)){var s=new FileReader;s.onload=function(e){t.textContent=s.result,document.getElementById("noconf").textContent="",initConf()},s.readAsText(n)}else t.textContent="File type not supported!"}));var l=document.getElementById("dataFile"),n=document.getElementById("dataFileContent");l.addEventListener("change",(function(e){var t=l.files[0];if(t.type.match(/text.*/)){var s=new FileReader;s.onload=function(e){n.textContent=s.result,document.getElementById("nodata").textContent="",initData()},s.readAsText(t)}else n.textContent="File type not supported!"}))};
