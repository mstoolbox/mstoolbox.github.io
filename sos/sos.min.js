var electron=.00054386734,end3mass=0,end5mass=0,furanmass=0,symbols=[],bases=[],basemass=[],sugars=[],sugarmass=[],link1=[],link1mass=[],link2=[],link2mass=[],link3=[],link3mass=[],elements=[],elmass=[],massElem=[],allData=[],allKeys=[],allInt=[];function myFunction(){calcNew()}function changeMenu(e){"item1"==e?(document.getElementById("myInput").style.display="block",document.getElementById("mySpectrum").style.display="none",document.getElementById("mySequence").style.display="none",document.getElementById("myAbout").style.display="none"):"item2"==e?(document.getElementById("myInput").style.display="none",document.getElementById("mySpectrum").style.display="none",document.getElementById("mySequence").style.display="block",document.getElementById("myAbout").style.display="none",calcNew()):"item3"==e?(document.getElementById("myInput").style.display="none",document.getElementById("mySpectrum").style.display="block",document.getElementById("mySequence").style.display="none",document.getElementById("myAbout").style.display="none",drawSpec()):"item4"==e&&(document.getElementById("myInput").style.display="none",document.getElementById("mySpectrum").style.display="none",document.getElementById("mySequence").style.display="none",document.getElementById("myAbout").style.display="block"),document.getElementById("item1").style.color="white",document.getElementById("item2").style.color="white",document.getElementById("item3").style.color="white",document.getElementById("item4").style.color="white",document.getElementById(e).style.color="yellow"}function changeIontype(){var e=["w","a-B","d-H2O","y","int"],t=document.getElementById("iontype");t.value=e[(e.indexOf(t.value)+1)%e.length],calcNew()}function changeCharge(e){var t=document.getElementById("charge");t.value=0==e?-1:1*t.value+e,calcNew()}function clearSeq(){var e=document.getElementById("seq");e.value="",(e=document.getElementById("charge")).value=-1,(e=document.getElementById("iontype")).value="w",calcNew()}function makeArray(e){return e.split(/=/)[1].split(/\|/)}function initConf(){end3mass=0,end5mass=0,furanmass=0,symbols=[],bases=[],basemass=[],sugars=[],sugarmass=[],link1=[],link1mass=[],link2=[],link2mass=[],link3=[],link3mass=[],elements=[],elmass=[],massElem=[],document.getElementById("seq").value="";var e=document.getElementById("confFileContent").textContent.split(/\r\n|\n/);document.getElementById("confRec").textContent="["+e.length+" lines read]";for(var t=0;t<e.length;t++)if(e[t].includes("elements"))elements=makeArray(e[t]);else if(e[t].includes("elmass")){elmass=makeArray(e[t]);for(var n=0;n<elements.length;n++)massElem[elements[n]]=elmass[n]}else if(e[t].includes("end3")){var l=e[t].split(/=/);end3mass=calcMass(l[1])}else if(e[t].includes("end5")){l=e[t].split(/=/);end5mass=calcMass(l[1])}else if(e[t].includes("furan")){l=e[t].split(/=/);furanmass=calcMass(l[1])}else if(e[t].includes("symbols"))(symbols=makeArray(e[t])).length=symbols.length<8?symbols.length:8;else if(e[t].includes("bases")){bases=makeArray(e[t]);for(n=0;n<symbols.length;n++)basemass[symbols[n]]=calcMass(bases[n])}else if(e[t].includes("sugars")){sugars=makeArray(e[t]);for(n=0;n<symbols.length;n++)sugarmass[symbols[n]]=calcMass(sugars[n])}else if(e[t].includes("link1")){link1=makeArray(e[t]);for(n=0;n<symbols.length;n++)link1mass[symbols[n]]=calcMass(link1[n])}else if(e[t].includes("link2")){link2=makeArray(e[t]);for(n=0;n<symbols.length;n++)link2mass[symbols[n]]=calcMass(link2[n])}else if(e[t].includes("link3")){link3=makeArray(e[t]);for(n=0;n<symbols.length;n++)link3mass[symbols[n]]=calcMass(link3[n])}}function initData(){allData=[],allKeys=[],allInt=[];var e=document.getElementById("dataFileContent").textContent,t=document.getElementById("specInfo");t.textContent="";for(var n=e.split(/\r\n|\n/),l=[],a=0;a<n.length;a++)(l=n[a].split(/ |\t/))[0].match(/\d+[\\.\d]/)&&(allData[l[0]]=Number(l[1])),":"===n[a].charAt(0)&&(t.textContent=t.textContent+n[a]+"\n");allKeys=Object.keys(allData),allInt=allKeys.map((function(e){return allData[e]})),document.getElementById("dataRec").textContent="["+allKeys.length+" peaks read]"}function addRec(e){var t=e.match(/\d/);document.getElementById("seq").value;document.getElementById("seq").value+=symbols[t],calcNew()}function drawCanvas(e,t){if(t.match(/./)){document.getElementById(e).style.display="inline-block";var n=document.getElementById(e);n.width=n.height*(n.clientWidth/n.clientHeight);var l=n.getContext("2d");return l.clearRect(0,0,n.width,n.height),l.width=300,l.height=600,l.globalAlpha=.05,l.textAlign="center",l.font="127px Arial",l.fillStyle="#000000",l.fillText(t,75,200),l.globalAlpha=1,l.strokeStyle="#000000",l.lineWidth=1,l.beginPath(),l.moveTo(10,275),l.lineTo(140,275),l.moveTo(75,275),l.lineTo(75,285),l.moveTo(45,275),l.lineTo(45,280),l.moveTo(105,275),l.lineTo(105,280),l.moveTo(15,275),l.lineTo(15,280),l.moveTo(135,275),l.lineTo(135,280),l.stroke(),l}return document.getElementById(e).style.display="none",0}function drawPeak(e,t,n,l){var a,s;a=Math.round(75+30*(n-t)),s=Math.round(allData[n]/l*250),e.strokeStyle="#800000",e.lineWidth=1,e.beginPath(),e.moveTo(a,274),e.lineTo(a,274-s),e.stroke(),e.globalAlpha=1,e.font="10px Arial",e.fillStyle="#800000",e.textAlign="right",e.fillText(l,140,20)}function specPos(e,t,n){return 15+720/(t-e)*(n-e)}function drawSpec(){if(0==Object.keys(allData).length)return 0;document.getElementById("specCanvas").style.visibility="visible",document.getElementById("specCanvas").style.display="inline-block";var e=document.getElementById("specCanvas");e.width=e.height*(e.clientWidth/e.clientHeight);var t=e.getContext("2d");t.clearRect(0,0,e.width,e.height),t.strokeStyle="#000000",t.lineWidth=1,t.beginPath(),t.moveTo(10,375),t.lineTo(740,375),t.stroke();var n=Math.max.apply(null,allKeys),l=Math.min.apply(null,allKeys);n=100*Math.ceil(n/100),l=100*Math.floor(l/100);var a=0,s=0;t.globalAlpha=1,t.font="10px Arial",t.fillStyle="#000000",t.strokeStyle="#000000",t.textAlign="center";for(var o=l;o<=n;o+=100)a=specPos(l,n,o),t.beginPath(),t.moveTo(a,380),t.lineTo(a,375),t.stroke(),t.fillText(o,a,392);for(o=l+50;o<=n;o+=100)a=specPos(l,n,o),t.beginPath(),t.moveTo(a,378),t.lineTo(a,375),t.stroke();var m=Math.max.apply(null,allInt);t.strokeStyle="#800000";for(o=0;o<=allKeys.length;o++)a=specPos(l,n,allKeys[o]),s=350*allData[allKeys[o]]/m,s=Math.round(s),t.beginPath(),t.moveTo(a,374),t.lineTo(a,374-s),t.stroke()}function calcNew(){var e=0,t=document.getElementById("seq").value.toUpperCase(),n=document.getElementById("iontype").value,l=[],a=[],s=[];document.getElementById("seq").value=t;for(var o=0;o<symbols.length;o++){var m=[];l[o]=drawCanvas("myCanvas"+o,symbols[o]),a[o]=calcSeq(l[o],t+symbols[o],n);for(var i=0;i<allKeys.length;i++)Number(allKeys[i])<=a[o]+2&&Number(allKeys[i])>=a[o]-2&&(m.push(allKeys[i]),e=allData[allKeys[i]]>e?allData[allKeys[i]]:e);s.push(m)}for(o=0;o<symbols.length;o++)for(i=0;i<s[o].length;i++)drawPeak(l[o],a[o],s[o][i],e)}function calcMass(e){var t=0,n=e.split(/\D/);n.splice(0,1),e=e.replace(/\d/g,""),arr2=e.split("");for(var l=0;l<n.length;l++)""==n[l]?n[l]=1:n[l]=Number(n[l]),t+=n[l]*massElem[arr2[l]];return t}function calcSeq(e,t,n){for(var l,a=Number(massElem.H),s=0;s<t.length;s++)a+=sugarmass[t[s]],a+=basemass[t[s]],a+=link1mass[t[s]],a+=link2mass[t[s]],a+=link3mass[t[s]];"w"==n?a+=end3mass:"a-B"==n?a+=end5mass+sugarmass[symbols[1]]-calcMass("H3"):"y"==n?a+=end3mass-link1mass[t[t.length-1]]-link2mass[t[t.length-1]]:"d-H2O"==n?a+=end5mass-calcMass("H2O"):"int"==n&&(a+=0-calcMass("H2")+link1mass[t[t.length-1]]+link2mass[t[t.length-1]]+link3mass[t[t.length-1]]+sugarmass[t[t.length-1]]);var o=Number(document.getElementById("charge").value);return a+=-1*o*(electron-Number(massElem.H)),l=a/=Math.abs(0==o?1:o),a=(a=Math.round(1e3*a)/1e3+"00").substring(0,a.indexOf(".")+4),n.match(/./)&&(e.globalAlpha=1,e.font="10px Arial",e.fillStyle="#000000",e.textAlign="center",e.fillText(a,75,295)),l}function loadConf(e){document.getElementById("confFileContent").textContent="",fetch(e).then((e=>e.text())).then((e=>{document.getElementById("confFileContent").textContent=e,document.getElementById("noconf").textContent="",initConf()})).catch((e=>console.log(e))),document.getElementById("confRec").textContent=""}function loadSpec(e){document.getElementById("dataFileContent").textContent="",fetch(e).then((e=>e.text())).then((e=>{document.getElementById("dataFileContent").textContent=e,document.getElementById("nodata").textContent="",initData()})).catch((e=>console.log(e))),document.getElementById("dataRec").textContent=""}window.onload=function(){var e=document.getElementById("confFile"),t=document.getElementById("confFileContent");e.addEventListener("change",(function(n){var l=e.files[0];if(l.type.match(/text.*/)){var a=new FileReader;a.onload=function(e){t.textContent=a.result,document.getElementById("noconf").textContent="",initConf()},a.readAsText(l)}else t.textContent="File type not supported!"}));var n=document.getElementById("dataFile"),l=document.getElementById("dataFileContent");n.addEventListener("change",(function(e){var t=n.files[0];if(t.type.match(/text.*/)){var a=new FileReader;a.onload=function(e){l.textContent=a.result,document.getElementById("nodata").textContent="",initData()},a.readAsText(t)}else l.textContent="File type not supported!"}))};
